name: Render Short Video

on:
  repository_dispatch:
    types: [render_video]
  
  workflow_dispatch:
    inputs:
      payload:
        description: 'JSON payload with video_url, story_title, script'
        required: true
        type: string

jobs:
  render:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          echo "FFmpeg version:"
          ffmpeg -version | head -1
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install gdown  # Fallback for Google Drive
      
      - name: Setup rclone for Google Drive
        run: |
          # Install rclone
          curl https://rclone.org/install.sh | sudo bash
          
          # Configure rclone from secret
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          
          # Verify rclone is configured
          rclone listremotes
      
      - name: Prepare payload (repository_dispatch)
        if: github.event_name == 'repository_dispatch'
        run: |
          cat << 'EOF' > /tmp/payload.json
          ${{ toJson(github.event.client_payload) }}
          EOF
          echo "PAYLOAD_FILE=/tmp/payload.json" >> $GITHUB_ENV
      
      - name: Prepare payload (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo '${{ github.event.inputs.payload }}' > /tmp/payload.json
          echo "PAYLOAD_FILE=/tmp/payload.json" >> $GITHUB_ENV
      
      - name: Render video
        id: render
        run: |
          PAYLOAD=$(cat $PAYLOAD_FILE)
          python render_video.py --payload "$PAYLOAD"
      
      - name: Call n8n webhook with download URL
        if: success() && vars.N8N_WEBHOOK_URL != ''
        run: |
          curl -X POST "${{ vars.N8N_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "success",
              "filename": "${{ steps.render.outputs.filename }}",
              "download_url": "${{ steps.render.outputs.download_url }}",
              "title": "${{ steps.render.outputs.title }}"
            }'
      
      - name: Notify failure webhook
        if: failure() && vars.N8N_WEBHOOK_URL != ''
        run: |
          curl -X POST "${{ vars.N8N_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "status": "failed",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }'
